generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model OwnerAccount {
  id                      String   @id @default(uuid()) @db.Uuid
  type                    String   // 'owner' | 'association'
  name                    String
  status                  String   // 'active' | 'suspended' | 'pending_verification'
  contactEmail            String
  payoutProviderRef       String?  // Square merchant_id
  squareAccessTokenEncrypted String?  // Encrypted Square OAuth access_token
  squareRefreshTokenEncrypted String? // Encrypted Square OAuth refresh_token
  squareTokenExpiresAt    DateTime? // When access_token expires
  squareLocationId        String?  // Owner (seller) Square location ID for marketplace payments
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  games                   Game[]
  users                   OwnerUser[]
  ledgerEntries           LedgerEntry[]
  payouts                 Payout[]
  organizations           Organization[]
  viewerSquareCustomers   ViewerSquareCustomer[]
  
  @@index([status])
  @@index([payoutProviderRef])
  @@index([squareLocationId])
}

model OwnerUser {
  id            String       @id @default(uuid()) @db.Uuid
  ownerAccountId String      @db.Uuid
  email         String
  passwordHash  String       // bcrypt hashed password
  role          String       // 'owner_admin' | 'association_admin' | 'association_operator'
  mfaEnabled    Boolean      @default(false)
  mfaSecret     String?      // Encrypted TOTP secret
  status        String       @default("active")
  createdAt     DateTime     @default(now())
  lastLoginAt   DateTime?
  
  ownerAccount OwnerAccount @relation(fields: [ownerAccountId], references: [id])
  organizationMemberships OrganizationMember[]
  
  @@index([ownerAccountId])
  @@index([email])
  @@unique([email])
}

model Game {
  id            String        @id @default(uuid()) @db.Uuid
  ownerAccountId String      @db.Uuid
  title         String
  homeTeam      String
  awayTeam      String
  startsAt      DateTime
  endsAt        DateTime?
  state         String        @default("draft") // 'draft' | 'active' | 'live' | 'ended' | 'cancelled'
  priceCents    Int
  currency      String        @default("USD")
  keywordCode   String        @unique
  keywordStatus String        @default("active") // 'active' | 'disabled' | 'rotated'
  qrUrl         String
  streamSourceId String?      @db.Uuid
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  cancelledAt   DateTime?
  
  ownerAccount OwnerAccount  @relation(fields: [ownerAccountId], references: [id])
  streamSource StreamSource?
  purchases    Purchase[]
  chatMessages GameChatMessage[]
  
  @@index([ownerAccountId])
  @@index([keywordCode])
  @@index([state])
}

model StreamSource {
  id                String   @id @default(uuid()) @db.Uuid
  gameId            String   @db.Uuid @unique
  type              String   // 'mux_managed' | 'byo_hls' | 'byo_rtmp' | 'external_embed'
  protectionLevel   String   // 'strong' | 'moderate' | 'best_effort'
  
  // Mux-managed
  muxAssetId        String?
  muxPlaybackId     String?
  
  // BYO HLS
  hlsManifestUrl    String?
  
  // BYO RTMP
  rtmpPublishUrl    String?
  rtmpStreamKey     String?  // Encrypted
  
  // External embed
  externalEmbedUrl  String?
  externalProvider  String?  // 'youtube' | 'twitch' | 'vimeo' | 'other'
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  game              Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  
  @@index([gameId])
}

model ViewerIdentity {
  id              String     @id @default(uuid()) @db.Uuid
  email           String     @unique
  phoneE164       String?
  firstName       String?    // For direct stream unlock + chat display
  lastName        String?    // For direct stream unlock + chat display
  smsOptOut       Boolean    @default(false)
  optOutAt        DateTime?
  createdAt       DateTime   @default(now())
  lastSeenAt      DateTime?
  
  purchases       Purchase[]
  subscriptions  Subscription[]
  viewerSquareCustomers ViewerSquareCustomer[]
  chatMessages    GameChatMessage[]
  
  @@index([email])
  @@index([phoneE164])
}

// Per-owner Square customer mapping (required for marketplace Model A + saved cards correctness).
// IMPORTANT: reference IDs only. No card data is stored in FieldView.
model ViewerSquareCustomer {
  id             String       @id @default(uuid()) @db.Uuid
  ownerAccountId String       @db.Uuid
  viewerId       String       @db.Uuid
  squareCustomerId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  ownerAccount   OwnerAccount @relation(fields: [ownerAccountId], references: [id])
  viewer         ViewerIdentity @relation(fields: [viewerId], references: [id])

  @@unique([ownerAccountId, viewerId])
  @@index([ownerAccountId])
  @@index([viewerId])
  @@index([squareCustomerId])
}

model Purchase {
  id                      String     @id @default(uuid()) @db.Uuid
  gameId                  String?    @db.Uuid  // Made optional
  channelId               String?    @db.Uuid  // Added for watch-link purchases
  eventId                 String?    @db.Uuid  // Added for event-scoped purchases
  viewerId                String     @db.Uuid
  amountCents             Int
  currency                String     @default("USD")
  platformFeeCents        Int
  processorFeeCents       Int
  ownerNetCents           Int
  status                  String     // 'created' | 'paid' | 'failed' | 'refunded' | 'partially_refunded'
  paymentProviderPaymentId String?
  paymentProviderCustomerId String?

  // Coupon discount
  couponCodeId            String?    @db.Uuid
  discountCents           Int        @default(0)

  // Payout recipient tracking (for admin visibility)
  recipientOwnerAccountId String?    @db.Uuid
  recipientType           String?    // 'personal' | 'organization'
  recipientOrganizationId String?    @db.Uuid

  createdAt               DateTime   @default(now())
  paidAt                  DateTime?
  failedAt                DateTime?
  refundedAt              DateTime?

  game                    Game?       @relation(fields: [gameId], references: [id])
  channel                 WatchChannel? @relation(fields: [channelId], references: [id])
  event                   Event?       @relation(fields: [eventId], references: [id])
  viewer                  ViewerIdentity @relation(fields: [viewerId], references: [id])
  couponCode              CouponCode? @relation(fields: [couponCodeId], references: [id])
  entitlement             Entitlement?
  paymentAttempts         PaymentAttempt[]
  refunds                 Refund[]

  @@index([gameId])
  @@index([channelId])
  @@index([eventId])
  @@index([viewerId])
  @@index([status])
  @@index([recipientOwnerAccountId])
  @@index([recipientType])
  @@index([couponCodeId])
}

model Entitlement {
  id          String     @id @default(uuid()) @db.Uuid
  purchaseId  String     @db.Uuid @unique
  tokenId     String     @unique // Hash of token claims
  validFrom   DateTime
  validTo     DateTime
  status      String     @default("active") // 'active' | 'expired' | 'revoked'
  createdAt   DateTime   @default(now())
  revokedAt   DateTime?
  
  purchase    Purchase   @relation(fields: [purchaseId], references: [id])
  sessions    PlaybackSession[]
  
  @@index([purchaseId])
  @@index([tokenId])
}

model PlaybackSession {
  id              String     @id @default(uuid()) @db.Uuid
  entitlementId   String     @db.Uuid
  startedAt       DateTime   @default(now())
  endedAt         DateTime?
  deviceHash      String?
  ipHash          String?
  userAgent       String?
  state           String     @default("started") // 'started' | 'ended' | 'error'
  
  // Telemetry summary
  totalWatchMs    Int        @default(0)
  totalBufferMs   Int        @default(0)
  bufferEvents    Int        @default(0)
  fatalErrors     Int        @default(0)
  startupLatencyMs Int?
  
  entitlement     Entitlement @relation(fields: [entitlementId], references: [id])
  
  @@index([entitlementId])
}

model Refund {
  id              String     @id @default(uuid()) @db.Uuid
  purchaseId      String     @db.Uuid
  amountCents     Int
  reasonCode      String     // 'buffer_ratio_high' | 'buffer_ratio_medium' | 'excessive_buffering' | 'fatal_error' | 'manual'
  issuedBy        String     // 'auto' | 'admin' | 'superadmin'
  ruleVersion     String     // Refund rule version applied
  telemetrySummary Json      // JSON snapshot of telemetry inputs
  createdAt       DateTime   @default(now())
  processedAt     DateTime?
  
  purchase        Purchase   @relation(fields: [purchaseId], references: [id])
  
  @@index([purchaseId])
}

model LedgerEntry {
  id            String     @id @default(uuid()) @db.Uuid
  ownerAccountId String    @db.Uuid
  type          String     // 'charge' | 'platform_fee' | 'processor_fee' | 'refund' | 'payout'
  amountCents   Int        // Positive for credits, negative for debits
  currency      String     @default("USD")
  referenceType String     // 'purchase' | 'refund' | 'payout'
  referenceId   String?
  description   String
  createdAt     DateTime   @default(now())
  
  ownerAccount  OwnerAccount @relation(fields: [ownerAccountId], references: [id])
  
  @@index([ownerAccountId])
  @@index([referenceType, referenceId])
}

model GameChatMessage {
  id          String     @id @default(uuid()) @db.Uuid
  gameId      String     @db.Uuid
  viewerId    String     @db.Uuid
  displayName String     // e.g., "First L." for privacy
  message     String     // 1-240 chars
  createdAt   DateTime   @default(now())
  
  game        Game           @relation(fields: [gameId], references: [id], onDelete: Cascade)
  viewer      ViewerIdentity @relation(fields: [viewerId], references: [id], onDelete: Cascade)
  
  @@index([gameId, createdAt(sort: Desc)])
  @@index([viewerId, createdAt(sort: Desc)])
}

model Payout {
  id              String     @id @default(uuid()) @db.Uuid
  ownerAccountId  String     @db.Uuid
  amountCents     Int
  currency         String     @default("USD")
  status           String     // 'pending' | 'processing' | 'completed' | 'failed'
  payoutProviderRef String?    // Square transfer ID
  ledgerEntryIds   String[]   // Array of ledger entry IDs
  createdAt        DateTime   @default(now())
  processedAt      DateTime?
  completedAt      DateTime?
  
  ownerAccount     OwnerAccount @relation(fields: [ownerAccountId], references: [id])
  
  @@index([ownerAccountId])
  @@index([status])
}

model SMSMessage {
  id              String     @id @default(uuid()) @db.Uuid
  direction       String     // 'inbound' | 'outbound'
  phoneE164       String
  keywordCode     String?
  gameId          String?    @db.Uuid
  messageBody     String
  status          String     // 'sent' | 'delivered' | 'failed'
  providerMessageId String?
  createdAt       DateTime   @default(now())
  deliveredAt     DateTime?
  
  @@index([phoneE164])
  @@index([keywordCode])
}

model AdminAccount {
  id            String       @id @default(uuid()) @db.Uuid
  email         String       @unique
  passwordHash  String       // bcrypt hashed password
  role          String       // 'support_admin' | 'super_admin'
  mfaEnabled    Boolean      @default(false)
  mfaSecret     String?      // Encrypted TOTP secret
  status        String       @default("active") // 'active' | 'suspended'
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  lastLoginAt   DateTime?
  
  auditLogs     AdminAuditLog[]
  
  @@index([email])
  @@index([status])
}

model AdminAuditLog {
  id              String     @id @default(uuid()) @db.Uuid
  adminUserId     String     @db.Uuid
  actionType      String     // 'refund_create' | 'resend_sms' | 'keyword_disable' | 'view_audience' | etc.
  targetType      String     // 'purchase' | 'game' | 'owner' | 'config' | 'viewer'
  targetId        String?
  reason          String?
  requestMetadata Json       // JSON snapshot (redacted)
  createdAt       DateTime   @default(now())
  
  adminAccount    AdminAccount @relation(fields: [adminUserId], references: [id])
  
  @@index([adminUserId])
  @@index([targetType, targetId])
  @@index([createdAt])
}

model Organization {
  id             String   @id @default(uuid()) @db.Uuid
  ownerAccountId String   @db.Uuid
  shortName      String   @unique
  name           String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  ownerAccount   OwnerAccount @relation(fields: [ownerAccountId], references: [id])
  channels       WatchChannel[]
  members        OrganizationMember[]
  events         Event[]
  subscriptions  Subscription[]

  @@index([ownerAccountId])
  @@index([shortName])
}

model WatchChannel {
  id               String   @id @default(uuid()) @db.Uuid
  organizationId   String   @db.Uuid
  teamSlug         String
  displayName      String
  requireEventCode Boolean  @default(false)

  // Access control
  accessMode       String   @default("public_free")  // 'public_free' | 'pay_per_view'
  priceCents       Int?
  currency         String?  @default("USD")

  // Current stream mapping (not tied to a Game)
  streamType       String   // 'mux_playback' | 'byo_hls' | 'external_embed'
  muxPlaybackId    String?
  hlsManifestUrl   String?
  externalEmbedUrl String?
  externalProvider String?  // 'youtube' | 'twitch' | 'vimeo' | 'other'

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  eventCodes       WatchEventCode[]
  purchases        Purchase[]
  events           Event[]
  subscriptions    Subscription[]

  @@unique([organizationId, teamSlug])
  @@index([organizationId])
}

model WatchEventCode {
  id          String   @id @default(uuid()) @db.Uuid
  channelId   String   @db.Uuid
  code        String
  status      String   @default("active") // 'active' | 'disabled'
  boundIpHash String?
  boundAt     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  channel     WatchChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([channelId, code])
  @@index([channelId])
  @@index([code])
}

model PaymentAttempt {
  id              String     @id @default(uuid()) @db.Uuid
  purchaseId      String     @db.Uuid
  status          String     // 'created' | 'succeeded' | 'failed'
  failureReason   String?
  providerResponse Json      // Provider-specific response
  createdAt       DateTime   @default(now())
  completedAt     DateTime?
  
  purchase        Purchase   @relation(fields: [purchaseId], references: [id])
  
  @@index([purchaseId])
}

model OrganizationMember {
  id             String   @id @default(uuid()) @db.Uuid
  ownerUserId    String   @db.Uuid
  organizationId String   @db.Uuid
  role           String   // 'org_admin' | 'team_manager' | 'coach'
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  ownerUser      OwnerUser    @relation(fields: [ownerUserId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([ownerUserId, organizationId])
  @@index([ownerUserId])
  @@index([organizationId])
  @@index([role])
}

model Subscription {
  id             String   @id @default(uuid()) @db.Uuid
  viewerId       String   @db.Uuid
  
  // Subscription target (at least one must be set)
  organizationId String?  @db.Uuid  // Subscribe to all events in org
  channelId      String?  @db.Uuid  // Subscribe to all events in team/channel
  eventId        String?  @db.Uuid  // Subscribe to specific event
  
  // Notification preferences
  preference     String   @default("email") // 'email' | 'sms' | 'both'
  confirmed      Boolean  @default(false)    // Email confirmation required
  confirmedAt    DateTime?
  
  // Status
  status         String   @default("active") // 'active' | 'unsubscribed' | 'bounced'
  unsubscribedAt DateTime?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  viewer         ViewerIdentity @relation(fields: [viewerId], references: [id], onDelete: Cascade)
  organization   Organization?  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  channel        WatchChannel?  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  event          Event?         @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([viewerId])
  @@index([organizationId])
  @@index([channelId])
  @@index([eventId])
  @@index([status])
  @@index([confirmed])
  // Note: At least one target (organizationId, channelId, or eventId) must be set
  // This is enforced at the application level via Zod schema validation
}

model Event {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @db.Uuid
  channelId      String   @db.Uuid
  startsAt       DateTime
  urlKey         String   // Generated from startsAt (YYYYMMDDHHmm) + suffix if needed
  canonicalPath  String   @unique // Rendered from preset/template (e.g., /StormFC/2010/202501301430)
  state          String   @default("scheduled") // 'scheduled' | 'live' | 'ended' | 'cancelled'
  
  // Stream source (can inherit from channel or override)
  streamType     String?  // 'mux_playback' | 'byo_hls' | 'external_embed'
  muxPlaybackId  String?
  hlsManifestUrl String?
  externalEmbedUrl String?
  externalProvider String? // 'youtube' | 'twitch' | 'vimeo' | 'other'
  
  // Pricing (inherit from channel or override)
  accessMode     String?  // 'public_free' | 'pay_per_view'
  priceCents     Int?
  currency       String?  @default("USD")
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  cancelledAt   DateTime?
  wentLiveAt     DateTime?
  endedAt        DateTime?

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  channel        WatchChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  purchases      Purchase[]
  subscriptions  Subscription[]

  @@unique([channelId, urlKey])
  @@index([organizationId])
  @@index([channelId])
  @@index([canonicalPath])
  @@index([state])
  @@index([startsAt])
}

model CouponCode {
  id                String     @id @default(uuid()) @db.Uuid
  code              String     @unique
  discountType      String     // 'percentage' | 'fixed_cents'
  discountValue     Int        // 10 for 10%, or 500 for $5.00
  ownerAccountId    String?    @db.Uuid   // null = global (any owner)
  gameId            String?    @db.Uuid   // null = all games
  maxUses           Int?                   // null = unlimited
  usedCount         Int        @default(0)
  maxUsesPerViewer  Int        @default(1)
  minPurchaseCents  Int?
  validFrom         DateTime   @default(now())
  validTo           DateTime?
  status            String     @default("active") // 'active' | 'disabled'
  createdAt         DateTime   @default(now())
  createdByAdminId  String     @db.Uuid

  redemptions       CouponRedemption[]
  purchases         Purchase[]

  @@index([code])
  @@index([status])
  @@index([ownerAccountId])
}

model CouponRedemption {
  id            String     @id @default(uuid()) @db.Uuid
  couponId      String     @db.Uuid
  purchaseId    String     @db.Uuid
  viewerId      String     @db.Uuid
  discountCents Int
  createdAt     DateTime   @default(now())

  coupon        CouponCode @relation(fields: [couponId], references: [id])

  @@unique([couponId, purchaseId])
  @@index([couponId])
  @@index([viewerId])
}
